Part
{
    // Variables
    batteryStorageMax = 2000
    transferQuantity = 1000
    transferInterval = 0.0625

    Components
    {
        // Toggles
        IsOperational
		{
			Type = MultiToggle
			Toggles = [BatteryStorage]
			Mode = All
		}

        CanProvideBatteryPower
        {
            Type = ThresholdToggle
            ValueFrom = BatteryStorage
            MinAmount = 0
        }

        IsProxyBatteryUpEmptyish
        {
            Type = ThresholdToggle
            ValueFrom = CombinedBatteryStorageNotDown
            MaxAmount = (&~/Part/batteryStorageMax) - (&~/Part/transferQuantity)
        }
        IsProxyBatteryDownEmptyish
        {
            Type = ThresholdToggle
            ValueFrom = CombinedBatteryStorageNotUp
            MaxAmount = (&~/Part/batteryStorageMax) - (&~/Part/transferQuantity)
        }
        IsProxyBatteryLeftEmptyish
        {
            Type = ThresholdToggle
            ValueFrom = CombinedBatteryStorageNotRight
            MaxAmount = (&~/Part/batteryStorageMax) - (&~/Part/transferQuantity)
        }
        IsProxyBatteryRightEmptyish
        {
            Type = ThresholdToggle
            ValueFrom = CombinedBatteryStorageNotLeft
            MaxAmount = (&~/Part/batteryStorageMax) - (&~/Part/transferQuantity)
        }

        IsBatteryEmptyish
		{
			Type = ThresholdToggle
			ValueFrom = BatteryStorage
			MaxAmount = (&~/Part/batteryStorageMax) - (&~/Part/transferQuantity)
		}

        // Proxies and combined storages
        ProxyBatteryStorageUp
        {
            Type = ResourceStorageProxy
            ResourceType = battery
            PartLocation = [0, -1]
            ProxyableComponents
            [
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 0
                    }
                    ComponentID = BatteryStorageDown
                }
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 1
                    }
                    ComponentID = BatteryStorageRight
                }
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 2
                    }
                    ComponentID = BatteryStorageUp
                }
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 3
                    }
                    ComponentID = BatteryStorageLeft
                }
                {
                    PartCriteria
                    {
                        Category = cable_receptor
                    }
                    ComponentID = BatteryStorage
                    IsOperational = IsBatteryEmptyish
                }
            ]
        }
        ProxyBatteryStorageDown
        {
            Type = ResourceStorageProxy
            ResourceType = battery
            PartLocation = [0, 1]
            ProxyableComponents
            [
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 0
                    }
                    ComponentID = BatteryStorageUp
                }
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 1
                    }
                    ComponentID = BatteryStorageLeft
                }
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 2
                    }
                    ComponentID = BatteryStorageDown
                }
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 3
                    }
                    ComponentID = BatteryStorageRight
                }
                {
                    PartCriteria
                    {
                        Category = cable_receptor
                    }
                    ComponentID = BatteryStorage
                    IsOperational = IsBatteryEmptyish
                }
            ]
        }
        ProxyBatteryStorageLeft
        {
            Type = ResourceStorageProxy
            ResourceType = battery
            PartLocation = [-1, 0]
            ProxyableComponents
            [
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 0
                    }
                    ComponentID = BatteryStorageRight
                }
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 1
                    }
                    ComponentID = BatteryStorageUp
                }
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 2
                    }
                    ComponentID = BatteryStorageLeft
                }
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 3
                    }
                    ComponentID = BatteryStorageLeftDown
                }
                {
                    PartCriteria
                    {
                        Category = cable_receptor
                    }
                    ComponentID = BatteryStorage
                    IsOperational = IsBatteryEmptyish
                }
            ]
        }
        ProxyBatteryStorageRight
        {
            Type = ResourceStorageProxy
            ResourceType = battery
            PartLocation = [1, 0]
            ProxyableComponents
            [
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 0
                    }
                    ComponentID = BatteryStorageLeft
                }
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 1
                    }
                    ComponentID = BatteryStorageDown
                }
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 2
                    }
                    ComponentID = BatteryStorageRight
                }
                {
                    PartCriteria
                    {
                        Category = cable
                        Rot = 3
                    }
                    ComponentID = BatteryStorageLeftUp
                }
                {
                    PartCriteria
                    {
                        Category = cable_receptor
                    }
                    ComponentID = BatteryStorage
                    IsOperational = IsBatteryEmptyish
                }
            ]
        }

        CombinedBatteryStorageNotUp
        {
            Type = MultiResourceStorage
            ResourceType = battery
            AddMode = PrioritizeMostEmptyCapacity
            ReceiveResourceMediaEffects = &/COMMON_EFFECTS/PowerDeliver
            ResourceStorages = [ProxyBatteryStorageDown, ProxyBatteryStorageLeft, ProxyBatteryStorageRight]
        }
        CombinedBatteryStorageNotDown
        {
            Type = MultiResourceStorage
            ResourceType = battery
            AddMode = PrioritizeMostEmptyCapacity
            ReceiveResourceMediaEffects = &/COMMON_EFFECTS/PowerDeliver
            ResourceStorages = [ProxyBatteryStorageUp, ProxyBatteryStorageLeft, ProxyBatteryStorageRight]
        }
        CombinedBatteryStorageNotLeft
        {
            Type = MultiResourceStorage
            ResourceType = battery
            AddMode = PrioritizeMostEmptyCapacity
            ReceiveResourceMediaEffects = &/COMMON_EFFECTS/PowerDeliver
            ResourceStorages = [ProxyBatteryStorageUp, ProxyBatteryStorageDown, ProxyBatteryStorageRight]
        }
        CombinedBatteryStorageNotRight
        {
            Type = MultiResourceStorage
            ResourceType = battery
            AddMode = PrioritizeMostEmptyCapacity
            ReceiveResourceMediaEffects = &/COMMON_EFFECTS/PowerDeliver
            ResourceStorages = [ProxyBatteryStorageUp, ProxyBatteryStorageDown, ProxyBatteryStorageLeft]
        }

        BatteryStorage
        {
            Type = MultiResourceStorage
            ResourceType = battery
            AddMode = DistributeEvenly
            RemoveMode = DistributeEvenly
            ResourceStorages = [BatteryStorageUp, BatteryStorageDown, BatteryStorageLeft, BatteryStorageRight]
        }

        // Real storages		
        BatteryStorageUp
        {
            Type = ResourceStorage
            ResourceType = battery
            MaxResources = &~/Part/batteryStorageMax
            IncludeWhenUnderConstruction = false
        }
        BatteryStorageDown
        {
            Type = ResourceStorage
            ResourceType = battery
            MaxResources = &~/Part/batteryStorageMax
            IncludeWhenUnderConstruction = false
        }
        BatteryStorageLeft
        {
            Type = ResourceStorage
            ResourceType = battery
            MaxResources = &~/Part/batteryStorageMax
            IncludeWhenUnderConstruction = false
        }
        BatteryStorageRight
        {
            Type = ResourceStorage
            ResourceType = battery
            MaxResources = &~/Part/batteryStorageMax
            IncludeWhenUnderConstruction = false
        }

        // Workers
        MoveBatteryPowerFromUp
        {
            Type = ResourceConverter
            FromStorage = BatteryStorageUp
            FromQuantity = &~/Part/transferQuantity
            ToStorage = CombinedBatteryStorageNotUp
            ToQuantity = &~/Part/transferQuantity
            Interval = &~/Part/transferInterval
            OperationalToggle = IsProxyBatteryDownEmptyish
        }
        MoveBatteryPowerFromDown
        {
            Type = ResourceConverter
            FromStorage = BatteryStorageDown
            FromQuantity = &~/Part/transferQuantity
            ToStorage = CombinedBatteryStorageNotDown
            ToQuantity = &~/Part/transferQuantity
            Interval = &~/Part/transferInterval
            OperationalToggle = IsProxyBatteryUpEmptyish
        }
        MoveBatteryPowerFromLeft
        {
            Type = ResourceConverter
            FromStorage = BatteryStorageLeft
            FromQuantity = &~/Part/transferQuantity
            ToStorage = CombinedBatteryStorageNotLeft
            ToQuantity = &~/Part/transferQuantity
            Interval = &~/Part/transferInterval
            OperationalToggle = IsProxyBatteryRightEmptyish
        }
        MoveBatteryPowerFromRight
        {
            Type = ResourceConverter
            FromStorage = BatteryStorageRight
            FromQuantity = &~/Part/transferQuantity
            ToStorage = CombinedBatteryStorageNotRight
            ToQuantity = &~/Part/transferQuantity
            Interval = &~/Part/transferInterval
            OperationalToggle = IsProxyBatteryLeftEmptyish
        }
    }

    Stats {
        MMCTPowerBandwidth = 1 / (&~/Part/transferInterval) * (&~/Part/transferQuantity) / 1000
        PowerCapacity = (&~/Part/batteryStorageMax) / 1000
    }
}
